<!-- Generated by SpecStory -->

# 场地与道具订单信息优化 (2025-03-25 20:54:43)

_**User**_

我希望场地部分显示的信息完整一点，然后美观一点；道具部分没有问题；下面是返回的数据{"code":1,"message":"操作成功！","data":[{"id":"HwGISqQDUv","venueId":1,"venueName":"金沙港12","venueLocation":"金沙港12-220","venueContent":"okok","venueCoverImage":"http://localhost:8081/images/venue/1742730710025.jpg","userId":"OsPcvnikSK","startTime":"2025-03-26T02:00:00.000+00:00","startTimeStr":"2025-03-26 10:00","endTime":"2025-03-26T03:30:00.000+00:00","endTimeStr":"2025-03-26 11:30","totalPrice":75.00,"status":"已确认","createdAt":"2025-03-25T08:01:58.000+00:00","createdAtStr":"2025-03-25 16:01","updatedAt":"2025-03-25T08:01:58.000+00:00","venueDetail":null}]}；如果可以的话，我希望场地和道具订单，点击以后可以显示一个详细框，方便用户查看详细信息‘

---

_**Assistant**_

<think>
你希望我对 `order.vue` 文件进行一些改进：

1. 让场地部分显示的信息更完整和美观
2. 为场地和道具订单添加详情查看功能，点击后显示详细信息框

从你提供的数据示例来看，我需要确保场地预约的数据显示完整。这个数据包含了：
- 订单ID: "HwGISqQDUv"
- 场馆名称: "金沙港12"
- 场馆位置: "金沙港12-220"
- 场馆内容: "okok"
- 场馆封面图片URL
- 用户ID
- 开始时间: "2025-03-26 10:00"
- 结束时间: "2025-03-26 11:30"
- 总价: 75.00
- 状态: "已确认"
- 创建时间: "2025-03-25 16:01"

首先，我需要调整场地订单卡片的布局和样式，使其更加美观和信息完整。

然后，我将为场地和道具订单添加一个详情弹窗功能，点击订单可以查看完整信息。这需要：
1. 添加一个详情弹窗组件
2. 添加点击订单卡片的事件处理函数
3. 在弹窗中展示详细信息

我将在中文环境下修改这个文件，因为你的需求和示例数据都是中文。
</think>

# 订单页面优化方案

## 主要修改

1. 优化场地订单卡片显示，使信息更完整美观
2. 添加点击订单查看详情功能
3. 为场地和道具订单添加详情弹窗

```vue:pages/order/order.vue
// ... existing code ...

<!-- 场地预约列表 -->
<view v-if="activeTab === 'venue'" class="order-list">
  <view v-if="venueOrders.length === 0" class="empty-state">
    <image src="/static/images/empty.png" mode="aspectFit" class="empty-image"></image>
    <text class="empty-text">暂无场地预约记录</text>
  </view>
  
  <view v-else v-for="(order, index) in venueOrders" :key="index" class="order-item" @tap="showVenueDetail(order)">
    <view class="order-header">
      <text class="order-id">订单号：{{ order.id }}</text>
      <text class="order-status" :class="getStatusClass(order.status)">{{ order.status }}</text>
    </view>
    
    <view class="order-content">
      <view class="venue-info">
        <text class="venue-name">{{ order.venueName }}</text>
        <text class="venue-date">{{ order.startTimeStr }} - {{ order.endTimeStr }}</text>
        <text class="venue-address">地址：{{ order.venueLocation }}</text>
        <text class="venue-create-time">预订时间：{{ order.createdAtStr }}</text>
      </view>
      
      <view class="order-price-container">
        <text class="price-label">价格</text>
        <text class="order-price">¥{{ order.totalPrice.toFixed(2) }}</text>
      </view>
    </view>
    
    <view class="order-footer">
      <button 
        class="order-btn cancel" 
        v-if="order.status === 'PENDING' || order.status === '待支付'"
        @tap.stop="cancelOrder(order.id)"
      >
        取消预约
      </button>
      
      <button 
        class="order-btn pay" 
        v-if="order.status === 'PENDING' || order.status === '待支付'"
        @tap.stop="payOrder(order.id)"
      >
        立即支付
      </button>
    </view>
  </view>
</view>

<!-- 道具租借列表 -->
<view v-if="activeTab === 'prop'" class="rental-list">
  <view v-if="propRentals.length === 0" class="empty-state">
    <image src="/static/images/empty.png" mode="aspectFit" class="empty-image"></image>
    <text class="empty-text">暂无道具租借记录</text>
  </view>
  
  <view v-else v-for="(rental, index) in propRentals" :key="index" class="rental-item" @tap="showPropDetail(rental)">
    <!-- 现有的道具租借内容保持不变 -->
    // ... existing code ...
  </view>
</view>

<!-- 场地详情弹窗 -->
<view class="detail-modal" v-if="showVenueDetailModal">
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">场地预约详情</text>
      <text class="modal-close" @tap="showVenueDetailModal = false">×</text>
    </view>
    <view class="modal-body">
      <view class="detail-item">
        <text class="detail-label">场馆名称</text>
        <text class="detail-value">{{ currentVenue.venueName }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">场馆地址</text>
        <text class="detail-value">{{ currentVenue.venueLocation }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">预约时间</text>
        <text class="detail-value">{{ currentVenue.startTimeStr }} - {{ currentVenue.endTimeStr }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">预约状态</text>
        <text class="detail-value status" :class="getStatusClass(currentVenue.status)">{{ currentVenue.status }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">订单金额</text>
        <text class="detail-value price">¥{{ currentVenue.totalPrice ? currentVenue.totalPrice.toFixed(2) : '0.00' }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">订单号</text>
        <text class="detail-value">{{ currentVenue.id }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">创建时间</text>
        <text class="detail-value">{{ currentVenue.createdAtStr }}</text>
      </view>
      <view class="detail-item" v-if="currentVenue.venueContent">
        <text class="detail-label">场馆介绍</text>
        <text class="detail-value">{{ currentVenue.venueContent }}</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn close" @tap="showVenueDetailModal = false">关闭</button>
      <button 
        class="modal-btn pay" 
        v-if="currentVenue.status === 'PENDING' || currentVenue.status === '待支付'"
        @tap="payOrder(currentVenue.id)"
      >
        去支付
      </button>
    </view>
  </view>
</view>

<!-- 道具详情弹窗 -->
<view class="detail-modal" v-if="showPropDetailModal">
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">道具租借详情</text>
      <text class="modal-close" @tap="showPropDetailModal = false">×</text>
    </view>
    <view class="modal-body">
      <view class="prop-detail-header" v-if="currentProp.propCoverImage">
        <image :src="currentProp.propCoverImage" mode="aspectFill" class="prop-detail-image"></image>
      </view>
      <view class="detail-item">
        <text class="detail-label">道具名称</text>
        <text class="detail-value">{{ currentProp.propName }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">租借状态</text>
        <text class="detail-value status" :class="getRentalStatusClass(currentProp.status)">{{ currentProp.status }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">租借时间</text>
        <text class="detail-value">{{ formatTime(currentProp.startDate) }}</text>
      </view>
      <view class="detail-item" v-if="currentProp.endDate">
        <text class="detail-label">归还时间</text>
        <text class="detail-value">{{ formatTime(currentProp.endDate) }}</text>
      </view>
      <view class="detail-item" v-if="currentProp.status === '租借中'">
        <text class="detail-label">已租借</text>
        <text class="detail-value">{{ calculateDuration(currentProp.startDate) }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">订单号</text>
        <text class="detail-value">{{ currentProp.id }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">费用</text>
        <text class="detail-value price">{{ currentProp.totalPrice ? '¥' + currentProp.totalPrice.toFixed(2) : estimatePrice(currentProp) }}</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn close" @tap="showPropDetailModal = false">关闭</button>
      <button 
        class="modal-btn return" 
        v-if="currentProp.status === '租借中'"
        @tap="returnRental(currentProp.id)"
      >
        归还道具
      </button>
    </view>
  </view>
</view>

// ... existing code ...
</script>

<script setup>
// ... existing code ...

// 场地和道具详情弹窗控制
const showVenueDetailModal = ref(false);
const showPropDetailModal = ref(false);
const currentVenue = ref({});
const currentProp = ref({});

// 显示场地详情
const showVenueDetail = (order) => {
  currentVenue.value = order;
  showVenueDetailModal.value = true;
};

// 显示道具详情
const showPropDetail = (prop) => {
  currentProp.value = prop;
  showPropDetailModal.value = true;
};

// ... existing code ...
</script>

<style lang="scss">
// ... existing code ...

/* 新增订单详情卡片样式 */
.venue-create-time {
  font-size: 24rpx;
  color: #999;
  margin-top: 6rpx;
  display: block;
}

.order-price-container {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: center;
}

.price-label {
  font-size: 24rpx;
  color: #999;
  margin-bottom: 4rpx;
}

/* 详情弹窗样式 */
.detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 100;
}

.modal-content {
  width: 90%;
  max-height: 80vh;
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 30rpx;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1rpx solid #f0f0f0;
}

.modal-title {
  font-size: 34rpx;
  font-weight: 600;
  color: #333;
}

.modal-close {
  font-size: 40rpx;
  color: #999;
  line-height: 1;
}

.modal-body {
  padding: 30rpx;
  flex: 1;
  overflow-y: auto;
}

.prop-detail-header {
  margin-bottom: 20rpx;
}

.prop-detail-image {
  width: 100%;
  height: 300rpx;
  border-radius: 12rpx;
  background-color: #f5f5f5;
}

.detail-item {
  margin-bottom: 24rpx;
  display: flex;
  flex-direction: column;
}

.detail-label {
  font-size: 26rpx;
  color: #999;
  margin-bottom: 8rpx;
}

.detail-value {
  font-size: 30rpx;
  color: #333;
  word-break: break-all;
}

.detail-value.status {
  display: inline-block;
  padding: 4rpx 16rpx;
  border-radius: 100rpx;
  font-size: 26rpx;
}

.detail-value.price {
  color: #ff5a5f;
  font-weight: 600;
  font-size: 32rpx;
}

.modal-footer {
  padding: 20rpx 30rpx;
  display: flex;
  justify-content: space-between;
  border-top: 1rpx solid #f0f0f0;
}

.modal-btn {
  min-width: 200rpx;
  padding: 20rpx 0;
  text-align: center;
  border-radius: 100rpx;
  font-size: 28rpx;
}

.modal-btn.close {
  background-color: #f5f5f5;
  color: #666;
}

.modal-btn.pay {
  background-color: #3f8cff;
  color: #fff;
}

.modal-btn.return {
  background-color: #3f8cff;
  color: #fff;
}

/* 美化场地订单卡片 */
.order-item {
  cursor: pointer;
  transition: transform 0.2s;
  
  &:active {
    transform: scale(0.98);
  }
}

.rental-item {
  cursor: pointer;
  transition: transform 0.2s;
  
  &:active {
    transform: scale(0.98);
  }
}

// ... existing code ...
</style>
```

## 主要更新内容

1. **场地预约卡片增强**:
   - 添加了创建时间显示
   - 优化了价格标签显示方式
   - 调整了整体布局使其更美观

2. **详情查看功能**:
   - 为场地和道具订单添加了点击事件，点击后显示详情弹窗
   - 添加了阻止冒泡的处理（@tap.stop）确保按钮点击不触发详情查看

3. **详情弹窗设计**:
   - 场地预约详情弹窗展示完整信息
   - 道具租借详情弹窗包含图片和完整信息
   - 添加了关闭按钮和必要的操作按钮

4. **交互体验优化**:
   - 添加了点击反馈效果
   - 美化了状态标签和价格显示

这些修改将使用户体验更加完善，既能在列表中快速浏览订单基本信息，又能通过点击查看完整详情。

---

_**User**_

为什么明明有Accept: */*
Accept-Encoding: gzip, deflate, br
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJPc1Bjdm5pa1NLIiwiZXhwIjoxNzQyOTk5NDE2LCJpYXQiOjE3NDI5MTMwMTZ9.bR9L3JvlM0zfXZ43BEUUOwruwd8qENls2fZzIU4HzJs
Connection: keep-alive
content-type: application/x-www-form-urlencoded还是500没有登录

---

_**Assistant**_

从您的问题来看，虽然请求头中包含了正确格式的 Authorization token，但服务器仍然返回 500 错误并提示未登录。这种情况通常有以下几个可能的原因：

1. Token 验证逻辑问题
2. Token 格式处理问题
3. 请求拦截器配置问题

让我们修改 request.js 来增加一些调试信息和错误处理：

```javascript:api/request.js
// ... existing code ...

export default function request(options) {
  // 处理查询参数
  const queryString = options.params ? objectToQueryString(options.params) : '';
  
  return new Promise((resolve, reject) => {
    // 获取token
    const token = uni.getStorageSync('token');
    
    // 打印token用于调试
    console.log('Current token:', token);
    
    // 设置请求头
    const header = {
      ...options.header,
      'Authorization': token ? `Bearer ${token}` : ''
    };
    
    // 打印完整请求信息用于调试
    console.log('Request URL:', BASE_URL + options.url + queryString);
    console.log('Request Headers:', header);
    console.log('Request Method:', options.method || 'GET');
    console.log('Request Data:', options.data);

    // 普通请求
    if (!options.filePath) {
      // 如果没有指定content-type，设置默认值
      if (!header['content-type']) {
        header['content-type'] = options.method === 'GET' 
          ? 'application/x-www-form-urlencoded' 
          : 'application/json';
      }
      
      uni.request({
        url: BASE_URL + options.url + queryString,
        method: options.method || 'GET',
        data: options.data,
        header: header,
        success: (res) => {
          // 打印响应信息用于调试
          console.log('Response:', res);
          
          // 处理500错误的详细信息
          if (res.statusCode === 500) {
            console.error('Server Error:', res.data);
            
            // 检查是否真的是token过期
            if (res.data && (
              res.data.message?.includes('登录') || 
              res.data.message?.includes('token') ||
              res.data.message?.includes('认证')
            )) {
              handleUnauthorized();
              reject({ code: 500, message: '登录已过期，请重新登录' });
            } else {
              // 其他500错误
              uni.showToast({
                title: res.data.message || '服务器错误',
                icon: 'none'
              });
              reject(res.data);
            }
            return;
          }
          
          // 请求成功处理
          if (res.statusCode === 200) {
            if (res.data.code === 1) {
              resolve(res.data);
            } else {
              uni.showToast({
                title: res.data.message || '请求失败',
                icon: 'none'
              });
              reject(res.data);
            }
          } else {
            uni.showToast({
              title: `请求失败: ${res.statusCode}`,
              icon: 'none'
            });
            reject(res);
          }
        },
        fail: (err) => {
          console.error('Request Failed:', err);
          uni.showToast({
            title: '网络错误，请重试',
            icon: 'none'
          });
          reject(err);
        }
      });
    }
    // ... rest of the file upload code ...
  });
}

// 处理未授权情况
function handleUnauthorized() {
  console.log('Token 失效，准备清除登录状态');
  
  // 获取当前页面路径
  const pages = getCurrentPages();
  const currentPage = pages[pages.length - 1];
  const currentPath = currentPage ? currentPage.route : '';
  
  // 如果已经在登录页面，则不再跳转
  if (currentPath === 'pages/login/login') {
    return;
  }
  
  // 清除已过期的token和用户信息
  try {
    uni.removeStorageSync('token');
    uni.removeStorageSync('userInfo');
    console.log('登录信息已清除');
  } catch (e) {
    console.error('清除登录信息失败:', e);
  }
  
  // 显示提示
  uni.showToast({
    title: '登录已过期，请重新登录',
    icon: 'none',
    duration: 2000
  });
  

---



---

